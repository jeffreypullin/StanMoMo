<<<<<<< HEAD
years.fitc<-as.character(years.fit)
#Extract death and exposures from the data base
dataStMoMo<-StMoMoData(data, series = "male")
death<-as.integer(as.vector(dataStMoMo$Dxt[ages.fitc,years.fitc]))
exposure<-as.integer(as.vector(dataStMoMo$Ext[ages.fitc,years.fitc]))
#As matrix
death<-dataStMoMo$Dxt[ages.fitc,years.fitc]
exposure<-dataStMoMo$Ext[ages.fitc,years.fitc]
fitLc<-lc_stan(death = death,exposure = exposure,forecast = 15,validation = 10,family = "poisson",cores=8)
devtools::load_all(".")
fitLc<-lc_stan(death = death,exposure = exposure,forecast = 15,validation = 10,family = "poisson",cores=8)
roxygen2::roxygenize()
lc_stan?
5
roxygen2::roxygenize()
roxygen2::roxygenize()
roxygen2::roxygenize()
roxygen2::roxygenize()
library(shinystan)
#visual convergence diagnostics
#library(shinystan)
launch_shinystan(fitLC)
#visual convergence diagnostics
#library(shinystan)
launch_shinystan(fitLc)
load("dataFR.RData")
FRMaleData
devtools::load_all(".")
load("FRMaleData")
FRMaleData
load("C:/Users/n15059/AppData/Local/Temp/EWMaleData.rda")
EWMaleData
death<-FRMaleData$Dxt
load("C:/Users/n15059/Dropbox/Recherche ISFA/Package StanMoMo/StanMoMo/data/FRMaleData.RData")
ages.fit<-as.character(50:90)
years.fit<-as.character(1970:2007)
death<-FRMaleData$Dxt[ages.fit,years.fit]
exposure<-FRMaleData$Ext[ages.fit,years.fit]
library("StanMoMo", lib.loc="~/R/R-3.6.2/library")
fitLC=lc_stan(death = death,exposure=exposure, forecast = 10, family = "poisson")
print(fitLC)
summary(fitLC)
library("fanplot")
library("RColorBrewer")
#And we can visualize some fan plots
#Alpha
plot(ages.fit, colMeans(params$a), ylim=range(params$a))
#And we can visualize some fan plots
params<-extract(fitLC)
#And we can visualize some fan plots
params<-rstan::extract(fitLC)
#Alpha
plot(ages.fit, colMeans(params$a), ylim=range(params$a))
fan(data=params$a, start=ages.fit[1],type = "interval", ln = c(95),probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Oranges"))))
test<-formatC(50:90)
ages.fit<-50:90
years.fit<-1970:2007
#Alpha
plot(ages.fit, colMeans(params$a), ylim=range(params$a))
fan(data=params$a, start=ages.fit[1],type = "interval", ln = c(95),probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Oranges"))))
#Beta
plot(ages.fit, colMeans(params$b), ylim=range(params$b))
fan(data=params$b, start=ages.fit[1],type = "interval", ln = c(95),probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Reds"))))
#Kappa
plot(years.fit, colMeans(params$k), ylim=range(params$k))
fan(data=params$k, start=years.fit[1],type = "percentile", probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Blues"))))
#Alpha
plot(ages.fit, colMeans(params$a), ylim=range(params$a))
fan(data=params$a, start=ages.fit[1],type = "percentile", ln = c(95),probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Oranges"))))
#Alpha
plot(ages.fit, colMeans(params$a), ylim=range(params$a))
fan(data=params$a, start=ages.fit[1],type = "interval", probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Oranges"))))
#Alpha
plot(ages.fit, colMeans(params$a), ylim=range(params$a))
fan(data=params$a, start=ages.fit[1],type = "interval", ln=c(95),ln=NULL,probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Oranges"))))
#Alpha
plot(ages.fit, colMeans(params$a), ylim=range(params$a))
fan(data=params$a, start=ages.fit[1],type = "interval", ln=NULL,probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Oranges"))))
load(data/"FRMaleData.RData")
load(/data/"FRMaleData.RData")
load(\data\"FRMaleData.RData")
library(knitr)
knit('leecarter.Rmd')
knit('leecarter.Rmd')
knit('leecarter.Rmd')
knit('leecarter.Rmd')
rstan:::rstudio_stanc("inst/stan/leecarter.stan")
library(StanMoMo)
ages.fit<-50:90
years.fit<-1970:2007
deathFR<-FRMaleData$Dxt[formatC(ages.fit),formatC(years.fit)]
exposureFR<-FRMaleData$Ext[formatC(ages.fit),formatC(years.fit)]
system.time(fitLC=lc_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "poisson",cores=4))
system.time({fitLC=lc_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "poisson",cores=4)})
system.time({fitLC=lc_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "poisson",cores=4)})
system.time({fitLC=lc_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "poisson",cores=1)})
system.time({fitLC=lc_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "poisson",cores=8)})
print(fitLC)
knitr::opts_chunk$set(echo = TRUE)
library("fanplot")
library("RColorBrewer")
params<-rstan::extract(fitLC)
plot(ages.fit, colMeans(params$a), ylim=range(params$a),ylab = expression(alpha_x))
plot(ages.fit, colMeans(params$a), ylim=range(params$a),ylab = expression(\alpha_x))
library(latex2exp)
install.packages("latex2exp")
library(latex2exp)
plot(ages.fit, colMeans(params$a), ylim=range(params$a),ylab=TeX("a_x"), xlab="Age: x")
plot(ages.fit, colMeans(params$a), ylim=range(params$a),ylab=TeX("\alpha_x"), xlab="Age: x")
plot(ages.fit, colMeans(params$a), ylim=range(params$a),ylab=TeX("$\alpha_x$"), xlab="Age: x")
plot(ages.fit, colMeans(params$a), ylim=range(params$a),ylab=TeX("$\\alpha_x$"), xlab="Age: x")
#Alpha
plot(ages.fit, colMeans(params$a), ylim=range(params$a),ylab=TeX("$\\alpha_x$"), xlab="Age: x")
fan(data=params$a, start=ages.fit[1],type = "interval", ln=NULL,probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Oranges"))))
plot(ages.fit, colMeans(params$b), ylim=range(params$b),ylab=TeX("$\\beta_x$"), xlab="Age: x")
fan(data=params$b, start=ages.fit[1],type = "interval", ln = NULL,probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Reds"))))
plot(years.fit, colMeans(params$k), ylim=range(params$k),ylab=TeX("$\\kappa_x$"), xlab="Year: t")
fan(data=params$k, start=years.fit[1],type = "percentile",ln = NULL, probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Blues"))))
library(tikzDevice)
install.packages("tikzDevice")
library(tikzDevice)
tikz("tikz-test.tex",width=15/2.54,height=12/2.54)
plot(ages.fit, colMeans(params$a), ylim=range(params$a),ylab=TeX("$\\alpha_x$"), xlab="Age: x")
fan(data=params$a, start=ages.fit[1],type = "interval", ln=NULL,probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Oranges"))))
#Define a matrix of predictions
pred<-params$mufor
dim(pred)
sample<-2*niter
sample<-4000
dim(pred)<-list(sample,length(ages.fit),10)
samplesize<-4000
forecastyears<-10
pred<-array(params$mufor,dim=list(samplesize,length(ages.fit),forecastyears),
dimnames = list(c(1:samplesize),formatC(ages.fit),formatC(years.fit)))
pred<-array(params$mufor,dim=list(samplesize,length(ages.fit),forecastyears))
samplesize<-4000
years.predict<-2008:2017
pred<-array(params$mufor,dim=list(samplesize,length(ages.fit),length(years.predict)),
dimnames = list(c(1:samplesize),formatC(ages.fit),formatC(years.predict)))
View(deathFR)
#Plot predictions without StMoMo
probs = c(2.5, 10, 25, 50, 75, 90, 97.5)
qxt <- deathFR / exposureFR
matplot(years.fit, t(qxt[c("65", "75", "85"), ]),
xlim = c(1970, 2017), ylim = c(0.0025, 0.2), pch = 20, col = "black",
log = "y", xlab = "year", ylab = "death rate (log scale)")
detach("package:tikzDevice", unload=TRUE)
matplot(years.fit, t(qxt[c("65", "75", "85"), ]),
xlim = c(1970, 2017), ylim = c(0.0025, 0.2), pch = 20, col = "black",
log = "y", xlab = "year", ylab = "death rate (log scale)")
library("StanMoMo", lib.loc="~/R/R-3.6.2/library")
ages.fit<-50:90
years.fit<-1970:2007
deathFR<-FRMaleData$Dxt[formatC(ages.fit),formatC(years.fit)]
exposureFR<-FRMaleData$Ext[formatC(ages.fit),formatC(years.fit)]
fitLC=lc_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "poisson",cores=4)
test<-fitLC@model_pars
test
print(fitLC,pars = "a")
library(knitr)
knit("leecarter.Rmd")
knit("leecarter.Rmd")
knit("leecarter.Rmd")
knit("leecarter.Rmd")
roxygen2::roxygenize()
pkgbuild::compile_dll()
pkgbuild::compile_dll() # see note below
roxygen2::roxygenize()
library("rstantools")
pkgbuild::compile_dll()
roxygen2::roxygenize()
roxygen2::roxygenize()
devtools::load_all(".")
ages.fit<-50:90
years.fit<-1970:2007
deathFR<-FRMaleData$Dxt[formatC(ages.fit),formatC(years.fit)]
exposureFR<-FRMaleData$Ext[formatC(ages.fit),formatC(years.fit)]
fitLC=rh_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "poisson",cores=4)
fitLC=rh_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "poisson",cores=1)
print(fitLC,pars = "a")
library("fanplot")
library("RColorBrewer")
library(latex2exp)
params<-rstan::extract(fitLC)
#Alpha
plot(ages.fit, colMeans(params$a), ylim=range(params$a),ylab=TeX("$\\alpha_x$"), xlab="Age: x")
fan(data=params$a, start=ages.fit[1],type = "interval", ln=NULL,probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Oranges"))))
plot(ages.fit, colMeans(params$b), ylim=range(params$b),ylab=TeX("$\\beta_x$"), xlab="Age: x")
fan(data=params$b, start=ages.fit[1],type = "interval", ln = NULL,probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Reds"))))
#Kappa
plot(years.fit, colMeans(params$k), ylim=range(params$k),ylab=TeX("$\\kappa_t$"), xlab="Year: t")
fan(data=params$k, start=years.fit[1],type = "percentile",ln = NULL, probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Blues"))))
cohort.fit<-(years.fit[1]-ages.fit[length(ages.fit)]):(years.fit[length(years.fit)]-ages.fit[1])
#gamma
plot(cohort.fit, colMeans(params$g), ylim=range(params$g))
fan(data=params$g, start=cohort.fit[1],type = "percentile", probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Blues"))))
samplesize<-4000
years.predict<-2008:2017
pred<-array(params$mufor,dim=list(samplesize,length(ages.fit),length(years.predict)),
dimnames = list(c(1:samplesize),formatC(ages.fit),formatC(years.predict)))
#Fan plots for ages 65,75,85
probs = c(2.5, 10, 25, 50, 75, 90, 97.5)
qxt <- deathFR / exposureFR
matplot(years.fit, t(qxt[c("65", "75", "85"), ]),
xlim = c(1970, 2017), ylim = c(0.0025, 0.2), pch = 20, col = "black",
log = "y", xlab = "year", ylab = "death rate (log scale)")
fan(pred[,"65" , ], start = 2008, probs = probs, n.fan = 4,
fan.col =  colorRampPalette(colors = rev(brewer.pal(9,"Reds"))), ln = NULL)
fan(pred[,"75" , ], start = 2008, probs = probs, n.fan = 4,
fan.col =  colorRampPalette(colors = rev(brewer.pal(9,"Greens"))), ln = NULL)
fan(pred[,"85" , ], start = 2008, probs = probs, n.fan = 4,
fan.col =  colorRampPalette(colors = rev(brewer.pal(9,"Blues"))), ln = NULL)
text(1980, qxt[c("65", "75", "85"), "2000"],
labels = c("x = 65", "x = 75", "x = 85"))
library(rstantools)
roxygen2::roxygenize()
pkgbuild::compile_dll()
devtools::install(quick=TRUE)
devtools::load_all(".")
ages.fit<-50:90
years.fit<-1970:2007
deathFR<-FRMaleData$Dxt[formatC(ages.fit),formatC(years.fit)]
exposureFR<-FRMaleData$Ext[formatC(ages.fit),formatC(years.fit)]
fitLC=lc_stan(death = deathFR,exposure=exposureFR, age=ages.fit,forecast = 10, family = "nb",cores=4)
fitLC=m6_stan(death = deathFR,exposure=exposureFR, age=ages.fit,forecast = 10, family = "nb",cores=4)
rstan:::rstudio_stanc("inst/stan/CBDmodel.stan")
rstan:::rstudio_stanc("inst/stan/M6model.stan")
fitLC=apc_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "nb",cores=4)
fitLC=apc_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "nb",cores=1)
library("StanMoMo", lib.loc="~/R/R-3.6.2/library")
fitLC=apc_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "poisson",cores=4)
fitLC=apc_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "poisson",cores=1)
rstan:::rstudio_stanc("inst/stan/RHmodel.stan")
roxygen2::roxygenize()
library(StanMoMo)
StanMoMo?
5+5
StanMoMo::apc_stan?
5+5
?`StanMoMo-package`
?apc_stan
ages.fit<-50:90
years.fit<-1970:2007
deathFR<-FRMaleData$Dxt[formatC(ages.fit),formatC(years.fit)]
exposureFR<-FRMaleData$Ext[formatC(ages.fit),formatC(years.fit)]
fitLC=m6_stan(death = deathFR,exposure=exposureFR, forecast = 10,age=ages.fit family = "poisson",cores=4)
fitLC=m6_stan(death = deathFR,exposure=exposureFR, forecast = 10,age=ages.fit,family = "nb",cores=4)
print(fitLC,pars = "k2")
library("fanplot")
library("RColorBrewer")
library(latex2exp)
params<-rstan::extract(fitLC)
#Kappa
plot(years.fit, colMeans(params$k), ylim=range(params$k),ylab=TeX("$\\kappa_t$"), xlab="Year: t")
fan(data=params$k, start=years.fit[1],type = "percentile",ln = NULL, probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Blues"))))
#Kappa
plot(years.fit, colMeans(params$k2), ylim=range(params$k2),ylab=TeX("$\\kappa_t$"), xlab="Year: t")
fan(data=params$k2, start=years.fit[1],type = "percentile",ln = NULL, probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Blues"))))
cohort.fit<-(years.fit[1]-ages.fit[length(ages.fit)]):(years.fit[length(years.fit)]-ages.fit[1])
plot(cohort.fit, colMeans(params$g), ylim=range(params$g))
fan(data=params$g, start=cohort.fit[1],type = "percentile", probs = seq(0.01,0.99,0.01),
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Blues"))))
#visual convergence diagnostics
#library(shinystan)
launch_shinystan(fitLC)
#visual convergence diagnostics
library(shinystan)
launch_shinystan(fitLC)
samplesize<-4000
years.predict<-2008:2017
pred<-array(params$mufor,dim=list(samplesize,length(ages.fit),length(years.predict)),
dimnames = list(c(1:samplesize),formatC(ages.fit),formatC(years.predict)))
#Fan plots for ages 65,75,85
probs = c(2.5, 10, 25, 50, 75, 90, 97.5)
qxt <- deathFR / exposureFR
matplot(years.fit, t(qxt[c("65", "75", "85"), ]),
xlim = c(1970, 2017), ylim = c(0.0025, 0.2), pch = 20, col = "black",
log = "y", xlab = "year", ylab = "death rate (log scale)")
fan(pred[,"65" , ], start = 2008, probs = probs, n.fan = 4,
fan.col =  colorRampPalette(colors = rev(brewer.pal(9,"Reds"))), ln = NULL)
fan(pred[,"75" , ], start = 2008, probs = probs, n.fan = 4,
fan.col =  colorRampPalette(colors = rev(brewer.pal(9,"Greens"))), ln = NULL)
fan(pred[,"85" , ], start = 2008, probs = probs, n.fan = 4,
fan.col =  colorRampPalette(colors = rev(brewer.pal(9,"Blues"))), ln = NULL)
text(1980, qxt[c("65", "75", "85"), "2000"],
labels = c("x = 65", "x = 75", "x = 85"))
#data<-hmd.mx(country="FRACNP", username="karim290492@gmail.com", password="longevity19", label="France")
load("dataFR.Rdata")
load("C:/Users/n15059/Dropbox/Recherche ISFA/R files/dataFR.RData")
ages.fit<-50:90
years.fit<-1970:2007
#Fit standard mortality models and regularization
library(StMoMo)
dataStMoMo<-StMoMoData(data, series = "male")
wxt <- genWeightMat(ages = ages.fit, years = years.fit)
M6fit <- fit(m6(link = "log"), data = dataStMoMo, ages.fit = ages.fit, years.fit=years.fit,wxt = wxt)
plot(M6fit,parametricbx = FALSE)
test<-M6fit$gc
test
RHfit<-M6fit
nsim<-500
RHsim<-simulate(M6fit,nsim = nsim,h=10)
probs = c(2.5, 10, 25, 50, 75, 90, 97.5)
qxt <- RHfit$Dxt / RHfit$Ext
matplot(RHfit$years, t(qxt[c("65", "75", "85"), ]),
xlim = c(1970, 2017), ylim = c(0.0025, 0.2), pch = 20, col = "black",
log = "y", xlab = "year", ylab = "mortality rate (log scale)")
fan(t(RHsim$rates["65", , ]), start = 2008, probs = probs, n.fan = 4,
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Reds"))), ln = NULL)
fan(t(RHsim$rates["75", , ]), start = 2008, probs = probs, n.fan = 4,
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Greens"))), ln = NULL)
fan(t(RHsim$rates["85", , ]), start = 2008, probs = probs, n.fan = 4,
fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Blues"))), ln = NULL)
devtools::install(quick=TRUE)
5+5
?mortality_weights
?
5
devtools::build_manual(pkg = ".", path = NULL)
library(rstan)
library("rstantools")
library(devtools)
devtools::install(quick=FALSE)
load("~/Dropbox/Recherche ISFA/Package StanMoMo/StanMoMo/data/FRMaleData.RData")
library("rstan", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
detach("package:rstan", unload=TRUE)
install.packages(c("rstan", "rstantools"))
library("rstantools")
install.packages("../StanMoMo", repos = NULL, type = "source")
install.packages("../StanMoMo", repos = NULL, type = "source")
library(StanMoMo)
roxygen2::roxygenize()
install.packages("../StanMoMo", repos = NULL, type = "source")
#Predictions for the StanMoMo package
library(StanMoMo)
library("fanplot")
library("RColorBrewer")
ages.fit<-50:90
years.fit<-1970:2007
deathFR<-FRMaleData$Dxt[formatC(ages.fit),formatC(years.fit)]
exposureFR<-FRMaleData$Ext[formatC(ages.fit),formatC(years.fit)]
fitCBD=cbd_stan(death = deathFR,exposure=exposureFR, age=ages.fit,forecast = 20, validation=10,family = "poisson",cores=4)
fitCBD=cbd_stan(death = deathFR,exposure=exposureFR, age=ages.fit,forecast = 20, validation=10,family = "poisson",cores=4)
library("rstan", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
library("rstanarm", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
fitCBD=cbd_stan(death = deathFR,exposure=exposureFR, age=ages.fit,forecast = 20, validation=10,family = "poisson",cores=4)
detach("package:rstanarm", unload=TRUE)
detach("package:rstan", unload=TRUE)
library("rstan", lib.loc="/Library/Frameworks/R.framework/Versions/3.6/Resources/library")
#Fit the five models
fitLC=lc_stan(death = deathFR,exposure=exposureFR, forecast = 20, validation=10,family = "poisson",cores=4)
fitCBD=cbd_stan(death = deathFR,exposure=exposureFR, age=ages.fit,forecast = 20, validation=10,family = "poisson",cores=4)
fitAPC=apc_stan(death = deathFR,exposure=exposureFR, forecast = 20, validation=10,family = "poisson",cores=4)
rstan:::get_CXX()
library("rstanlm")
fit <- lm_stan(y = rnorm(10), x = rnorm(10),
# arguments passed to sampling
iter = 2000, refresh = 500)
fitAPC=apc_stan(death = deathFR,exposure=exposureFR, forecast = 20, validation=10,family = "poisson",cores=4,iter=200)
fitCBD=cbd_stan(death = deathFR,exposure=exposureFR, age=ages.fit,forecast = 20, validation=10,family = "poisson",cores=4,iter=200)
library("rstantools")
roxygen2::roxygenize()
install.packages("../StanMoMo", repos = NULL, type = "source")
install.packages("../StanMoMo", repos = NULL, type = "source")
library("devtools", lib.loc="~/R/R-3.6.2/library")
devtools::install_github('kabarigou/StanMoMo')
devtools::install_github('kabarigou/StanMoMo',auth_token = "6ccd5b2475943e1d2bc829e7a03cc16ce0ee5623")
5+5
build_manual(path=getwd())
#Check the package
check()
library(devtools)
#Check the package
check()
library("StanMoMo", lib.loc="~/R/R-3.6.2/library")
?load_HMD_data()
death_fra <- load_HMD_data('FRATNP', 'Deaths_1x1', 1970:2017, 50:90, "Male")
library("dplyr", lib.loc="~/R/R-3.6.2/library")
death_fra <- load_HMD_data('FRATNP', 'Deaths_1x1', 1970:2017, 50:90, "Male")
library("tidyr", lib.loc="~/R/R-3.6.2/library")
death_fra <- load_HMD_data('FRATNP', 'Deaths_1x1', 1970:2017, 50:90, "Male")
detach("package:tidyr", unload=TRUE)
library("tibble", lib.loc="~/R/R-3.6.2/library")
death_fra <- load_HMD_data('FRATNP', 'Deaths_1x1', 1970:2017, 50:90, "Male")
library("tidyr", lib.loc="~/R/R-3.6.2/library")
death_fra <- load_HMD_data('FRATNP', 'Deaths_1x1', 1970:2017, 50:90, "Male")
load_HMD_data <- function(CNTRY, item, cal_year_range, age_range, gender){
username <- 'pierre.olivier.goffard@gmail.com'
password <- 'StanMoMo'
path <- paste0("https://www.mortality.org/hmd/", CNTRY,
"/STATS/", item)
TEXT <- httr::GET(path, httr::authenticate(username, password),
httr::config(ssl_verifypeer = 0L))
status <- httr::http_status(TEXT)
DF <- read.table(text = httr::content(TEXT, encoding = "UTF-8"),
header = TRUE, skip = 2, na.strings = ".",
as.is = TRUE)
DF <- DF %>% filter( (Age %in% age_range) & (Year %in% cal_year_range) ) %>% select(Year, Age, gender)
mat <- as.matrix(pivot_wider(DF, names_from = Year, values_from = gender) %>% column_to_rownames(., var = "Age"))
vect <- as.integer(as.vector(mat))
return(
list(DF = DF, mat = mat, vect = vect)
)
}
death_fra <- load_HMD_data('FRATNP', 'Deaths_1x1', 1970:2017, 50:90, "Male")
library(devtools)
use_gpl_license(version = 3, include_future = TRUE)
library(usethis)
use_gpl_license(version = 3, include_future = TRUE)
use_gpl3_license("Karim Barigou","Pierre-Olivier Goffard")
use_gpl3_license(c("Karim Barigou","Pierre-Olivier Goffard"))
use_gpl3_license(c("Karim Barigou","Pierre-Olivier Goffard"))
devtools::document()
devtools::document()
devtools::document()
?lc_stan
devtools::build_manual()
?lc_stan
library("StMoMo", lib.loc="~/R/R-3.6.2/library")
?lc
devtools::document()
devtools::build_manual()
preview_rd("lc_stan.Rd")
devtools::document()
devtools::build_manual()
devtools::document()
devtools::build_manual()
devtools::document()
devtools::build_manual()
devtools::build_manual()
devtools::document()
?lc_stan
devtools::document()
devtools::build_manual()
devtools::document()
devtools::build_manual()
devtools::document()
devtools::document()
devtools::build_manual()
devtools::document()
devtools::build_manual()
load_HMD_data <- function(CNTRY, item, cal_year_range, age_range, gender){
username <- 'pierre.olivier.goffard@gmail.com'
password <- 'StanMoMo'
path <- paste0("https://www.mortality.org/hmd/", CNTRY,
"/STATS/", item)
TEXT <- httr::GET(path, httr::authenticate(username, password),
httr::config(ssl_verifypeer = 0L))
status <- httr::http_status(TEXT)
DF <- read.table(text = httr::content(TEXT, encoding = "UTF-8"),
header = TRUE, skip = 2, na.strings = ".",
as.is = TRUE)
DF <- dplyr::filter(DF, (Age %in% age_range) & (Year %in% cal_year_range))
DF <-dplyr::select(DF,Year, Age, gender)
mat <- as.matrix(tibble::column_to_rownames(tidyr::pivot_wider(DF, names_from = Year, values_from = gender),., var = "Age"))
vect <- as.integer(as.vector(mat))
return(
list(DF = DF, mat = mat, vect = vect)
)
}
death_fra <- load_HMD_data('FRATNP', 'Deaths_1x1', 1970:2017, 50:90, "Male")
load_HMD_data <- function(CNTRY, item, cal_year_range, age_range, gender){
username <- 'pierre.olivier.goffard@gmail.com'
password <- 'StanMoMo'
path <- paste0("https://www.mortality.org/hmd/", CNTRY,
"/STATS/", item)
TEXT <- httr::GET(path, httr::authenticate(username, password),
httr::config(ssl_verifypeer = 0L))
status <- httr::http_status(TEXT)
DF <- read.table(text = httr::content(TEXT, encoding = "UTF-8"),
header = TRUE, skip = 2, na.strings = ".",
as.is = TRUE)
DF <- dplyr::filter(DF, (Age %in% age_range) & (Year %in% cal_year_range))
DF <-dplyr::select(DF,Year, Age, gender)
mat <- as.matrix(tibble::column_to_rownames(tidyr::pivot_wider(DF, names_from = Year, values_from = gender), var = "Age"))
vect <- as.integer(as.vector(mat))
return(
list(DF = DF, mat = mat, vect = vect)
)
}
death_fra <- load_HMD_data('FRATNP', 'Deaths_1x1', 1970:2017, 50:90, "Male")
library(devtools)
devtools::document()
devtools::document()
devtools::build_manual()
devtools::document()
devtools::build_manual()
load("C:/Users/n15059/Dropbox/Recherche ISFA/Package StanMoMo/StanMoMo/data/FRMaleData.RData")
View(FRMaleData)
test<-FRMaleData$Dxt
View(test)
typeof(FRMaleData)
devtools::document()
devtools::build_manual()
=======
death_sim_apc
gxt_apc
gxt_lc
phi_lc/(phi_lc+gxt)
post_mean_apc
post_mean_lc
phi_apc <- as.numeric(post_mean_apc %>% select('phi'))
phi_apc
names(apc_fit)
phi_apc/(phi_apc+gxt_apc)
gxt_lc/(gxt_lc+gxt)
gxt_lc/(phi_lc+gxt_lc)
death_sim_lc
death_sim_apc
phi_apc
phi_lc
# Test to see wether the true value of the paratmeter is within the psoterior distribution
lc_fit_sim <- lc_stan(death = death_sim_lc,exposure=death_sim_lc, validation=0,forecast = 1, family = "nb",chains=1,cores=4)
post_samples_sim <- as.data.frame(lc_fit_sim)
a_true <- t(post_mean_lc %>% select(starts_with('a[')))
b_true <- t(post_mean_lc %>% select(starts_with('b[')))
kt_true <-  t(post_mean_lc %>% select(starts_with('k[')))
phi_true <-  t(post_mean_lc %>% select(starts_with('phi')))
ages <- 50:90
years <- 1979:2008
ax_post = data.frame(a=double(), x = integer(), a_true = double())
for (k in 1:length(ages)){
ax_post = rbind(ax_post,
data.frame(a = as.numeric(t(post_samples_sim %>% select(paste0('a[',k,']')))), x = rep(ages[k],1000), a_true = rep(a_true[k],1000))
)
}
ggplot(data = ax_post) + geom_boxplot(mapping = aes(x = as.factor(x), y = a)) + geom_boxplot(mapping = aes(x = as.factor(x), y = a_true, color = 'red'))
a_true
ax_post = data.frame(a=double(), x = integer(), a_true = double())
for (k in 1:length(ages)){
ax_post = rbind(ax_post,
data.frame(a = as.numeric(t(post_samples_sim %>% select(paste0('a[',k,']')))), x = rep(ages[k],1000), a_true = rep(a_true[k],1000))
)
}
ax_post
# Test to see wether the true value of the paratmeter is within the psoterior distribution
lc_fit_sim <- lc_stan(death = death_sim_lc,exposure=exposureGBR, validation=0,forecast = 1, family = "nb",chains=1,cores=4)
post_samples_sim <- as.data.frame(lc_fit_sim)
a_true <- t(post_mean_lc %>% select(starts_with('a[')))
b_true <- t(post_mean_lc %>% select(starts_with('b[')))
kt_true <-  t(post_mean_lc %>% select(starts_with('k[')))
phi_true <-  t(post_mean_lc %>% select(starts_with('phi')))
ages <- 50:90
years <- 1979:2008
ax_post = data.frame(a=double(), x = integer(), a_true = double())
for (k in 1:length(ages)){
ax_post = rbind(ax_post,
data.frame(a = as.numeric(t(post_samples_sim %>% select(paste0('a[',k,']')))), x = rep(ages[k],1000), a_true = rep(a_true[k],1000))
)
}
ggplot(data = ax_post) + geom_boxplot(mapping = aes(x = as.factor(x), y = a)) + geom_boxplot(mapping = aes(x = as.factor(x), y = a_true, color = 'red'))
bx_post = data.frame(b=double(), x = integer(), b_true = double())
for (k in 1:length(ages)){
bx_post = rbind(bx_post,
data.frame(b = as.numeric(t(post_samples_sim %>% select(paste0('b[',k,']')))), x = rep(ages[k],1000), b_true = rep(b_true[k],1000))
)
}
ggplot(data = bx_post) + geom_boxplot(mapping = aes(x = as.factor(x), y = b)) + geom_boxplot(mapping = aes(x = as.factor(x), y = b_true, color = 'red'))
kt_post = data.frame(kt=double(), t = integer(), kt_true = double())
for(k in 1:length(years)){
kt_post = rbind(kt_post,
data.frame(kt = as.numeric(t(post_samples_sim %>% select(paste0('k[',k,']')))), t = rep(years[k],1000), kt_true = rep(kt_true[k],1000))
)
}
ggplot(data = kt_post) + geom_boxplot(mapping = aes(x = as.factor(t), y = kt)) + geom_boxplot(mapping = aes(x = as.factor(t), y = kt_true, color = 'red'))
phi_post = data.frame(phi = as.numeric(t(post_samples_sim %>% select('phi'))), phi_true = rep(phi_true,1000))
ggplot(data = phi_post) + geom_boxplot(mapping = aes(y = phi)) + geom_boxplot(mapping = aes(y = phi_true, color = 'red'))
for(i in 1:length(ages)){
for(j in 1:length(years)){
gxt_apc[i,j] <- exp(a_apc[i] + k_apc[j] + g_apc[match(years[j] - ages[i], cohorts)])*exposureGBR[i,j]
}
}
death_sim_apc <-  apply(gxt_apc, 1:2, function(gxt) rnbinom(1,size = phi_apc, prob = phi_apc/(phi_apc+gxt)))
death_sim_apc
death_sim_lc-death_sim_apc
apc_fit_sim <- apc_stan(death = death_sim_apc,exposure=exposureGBR, validation=0,forecast = 10, family = "nb",chains=1,cores=4)
post_samples_sim <- as.data.frame(apc_fit_sim)
a_true <- t(post_mean_apc %>% select(starts_with('a[')))
kt_true <-  t(post_mean_apc %>% select(starts_with('k[')))
g_true <-  t(post_mean_apc %>% select(starts_with('g[')))
phi_true <-  t(post_mean_apc %>% select(starts_with('phi')))
ages <- 50:90
years <- 1979:2008
phi_true
ax_post = data.frame(a=double(), x = integer(), a_true = double())
for (k in 1:length(ages)){
ax_post = rbind(ax_post,
data.frame(a = as.numeric(t(post_samples_sim %>% select(paste0('a[',k,']')))), x = rep(ages[k],1000), a_true = rep(a_true[k],1000))
)
}
ggplot(data = ax_post) + geom_boxplot(mapping = aes(x = as.factor(x), y = a)) + geom_boxplot(mapping = aes(x = as.factor(x), y = a_true, color = 'red'))
kt_post = data.frame(kt=double(), t = integer(), kt_true = double())
for(k in 1:length(years)){
kt_post = rbind(kt_post,
data.frame(kt = as.numeric(t(post_samples_sim %>% select(paste0('k[',k,']')))), t = rep(years[k],1000), kt_true = rep(kt_true[k],1000))
)
}
ggplot(data = kt_post) + geom_boxplot(mapping = aes(x = as.factor(t), y = kt)) + geom_boxplot(mapping = aes(x = as.factor(t), y = kt_true, color = 'red'))
g_post = data.frame(g=double(), t = integer(), g_true = double())
for(k in 1:length(cohorts)){
g_post = rbind(g_post,
data.frame(g = as.numeric(t(post_samples_sim %>% select(paste0('g[',k,']')))), co = rep(cohorts[k],1000), g_true = rep(g_true[k],1000))
)
}
ggplot(data = g_post) + geom_boxplot(mapping = aes(x = as.factor(co), y = g)) + geom_boxplot(mapping = aes(x = as.factor(co), y = g_true, color = 'red'))
phi_post = data.frame(phi = as.numeric(t(post_samples_sim %>% select('phi'))), phi_true = rep(phi_true,1000))
ggplot(data = phi_post) + geom_boxplot(mapping = aes(y = phi)) + geom_boxplot(mapping = aes(y = phi_true, color = 'red'))
# Test to see wether the true value of the true paratmeters are within the posterior distribution
lc_fit_sim <- lc_stan(death = death_sim_lc,exposure=exposureGBR, validation=0,forecast = 1, family = "nb",chains=1,cores=4)
# Test to see wether the true value of the true paratmeters are within the posterior distribution
apc_fit_sim <- apc_stan(death = death_sim_apc,exposure=exposureGBR, validation=0,forecast = 10, family = "nb",chains=1,cores=4)
library(StanMoMo)
library(tidyverse)
# library(ggplot2)
library(matrixcalc)
# library(purrr)
# help(load_HMD_data)
years <- 1979:2008
ages <- 50:90
cohorts <- sort(unique(as.vector(sapply(years, function(year) year - ages))))
deathGBR<-load_HMD_data('GBR_NP', 'Deaths_1x1', 1979:2008, 50:90, "Male")$mat
exposureGBR<-load_HMD_data('GBR_NP', 'Exposures_1x1', 1979:2008, 50:90, "Male")$mat
lc_fit <- lc_stan(death = deathGBR,exposure=exposureGBR, validation=0,forecast = 1, family = "nb",chains=1,cores=4)
apc_fit <- apc_stan(death = deathGBR,exposure=exposureGBR, validation=0,forecast = 10, family = "nb",chains=1,cores=4)
post_mean_lc <- as.data.frame(lc_fit) %>% select(starts_with('a['), starts_with('b['), starts_with('k['), 'phi') %>% summarise(across(everything(), mean))
post_mean_apc <- as.data.frame(apc_fit) %>% select(starts_with('a['), starts_with('g['), starts_with('k['), 'phi') %>% summarise(across(everything(), mean))
a_lc <- as.vector(t(post_mean_lc %>% select(starts_with('a['))))
b_lc <- as.vector(t(post_mean_lc %>% select(starts_with('b['))))
k_lc <- as.vector(t(post_mean_lc %>% select(starts_with('k['))))
phi_lc <- as.numeric(post_mean_lc %>% select('phi'))
a_apc <- as.vector(t(post_mean_apc %>% select(starts_with('a['))))
k_apc <- as.vector(t(post_mean_apc %>% select(starts_with('k['))))
g_apc <- as.vector(t(post_mean_apc %>% select(starts_with('g['))))
phi_apc <- as.numeric(post_mean_apc %>% select('phi'))
gxt_lc <- exp(sapply(k_lc, function(kt) a_lc + b_lc * kt))*exposureGBR[,1:length(years)]
colnames(exposureGBR)
rownames(exposureGBR)
years[1]-ages[1]
cohorts
gxt_apc <- 0*exposureGBR[,1:length(years)]
for(i in 1:length(ages)){
for(j in 1:length(years)){
gxt_apc[i,j] <- exp(a_apc[i] + k_apc[j] + g_apc[match(years[j] - ages[i], cohorts)])*exposureGBR[i,j]
}
}
# death_sim <- apply(lambda_mat,1:2, function(lam) rpois(1,lambda = lam))
# Negative binomial death count
death_sim_lc <- apply(gxt_lc, 1:2, function(gxt) rnbinom(1,size = phi_lc, prob = phi_lc/(phi_lc+gxt)))
death_sim_apc <-  apply(gxt_apc, 1:2, function(gxt) rnbinom(1,size = phi_apc, prob = phi_apc/(phi_apc+gxt)))
a_lc <- as.vector(t(post_mean_lc %>% select(starts_with('a['))))
b_lc <- as.vector(t(post_mean_lc %>% select(starts_with('b['))))
k_lc <- as.vector(t(post_mean_lc %>% select(starts_with('k['))))
phi_lc <- as.numeric(post_mean_lc %>% select('phi'))
a_apc <- as.vector(t(post_mean_apc %>% select(starts_with('a['))))
k_apc <- as.vector(t(post_mean_apc %>% select(starts_with('k['))))
g_apc <- as.vector(t(post_mean_apc %>% select(starts_with('g['))))
phi_apc <- as.numeric(post_mean_apc %>% select('phi'))
gxt_lc <- exp(sapply(k_lc, function(kt) a_lc + b_lc * kt))*exposureGBR[,1:length(years)]
gxt_apc <- 0*exposureGBR[,1:length(years)]
for(i in 1:length(ages)){
for(j in 1:length(years)){
gxt_apc[i,j] <- exp(a_apc[i] + k_apc[j] + g_apc[match(years[j] - ages[i], cohorts)])*exposureGBR[i,j]
}
}
# death_sim <- apply(lambda_mat,1:2, function(lam) rpois(1,lambda = lam))
# Negative binomial death count
death_sim_lc <- apply(gxt_lc, 1:2, function(gxt) rnbinom(1,size = phi_lc, prob = phi_lc/(phi_lc+gxt)))
death_sim_apc <-  apply(gxt_apc, 1:2, function(gxt) rnbinom(1,size = phi_apc, prob = phi_apc/(phi_apc+gxt)))
# Test to see wether the true value of the true paratmeters are within the posterior distribution
lc_fit_sim <- lc_stan(death = death_sim_lc,exposure=exposureGBR, validation=0,forecast = 1, family = "nb",chains=1,cores=4)
post_samples_sim <- as.data.frame(lc_fit_sim)
a_true <- t(post_mean_lc %>% select(starts_with('a[')))
b_true <- t(post_mean_lc %>% select(starts_with('b[')))
kt_true <-  t(post_mean_lc %>% select(starts_with('k[')))
phi_true <-  t(post_mean_lc %>% select(starts_with('phi')))
ages <- 50:90
years <- 1979:2008
ax_post = data.frame(a=double(), x = integer(), a_true = double())
for (k in 1:length(ages)){
ax_post = rbind(ax_post,
data.frame(a = as.numeric(t(post_samples_sim %>% select(paste0('a[',k,']')))), x = rep(ages[k],1000), a_true = rep(a_true[k],1000))
)
}
ggplot(data = ax_post) + geom_boxplot(mapping = aes(x = as.factor(x), y = a)) + geom_boxplot(mapping = aes(x = as.factor(x), y = a_true, color = 'red'))
bx_post = data.frame(b=double(), x = integer(), b_true = double())
for (k in 1:length(ages)){
bx_post = rbind(bx_post,
data.frame(b = as.numeric(t(post_samples_sim %>% select(paste0('b[',k,']')))), x = rep(ages[k],1000), b_true = rep(b_true[k],1000))
)
}
ggplot(data = bx_post) + geom_boxplot(mapping = aes(x = as.factor(x), y = b)) + geom_boxplot(mapping = aes(x = as.factor(x), y = b_true, color = 'red'))
kt_post = data.frame(kt=double(), t = integer(), kt_true = double())
for(k in 1:length(years)){
kt_post = rbind(kt_post,
data.frame(kt = as.numeric(t(post_samples_sim %>% select(paste0('k[',k,']')))), t = rep(years[k],1000), kt_true = rep(kt_true[k],1000))
)
}
ggplot(data = kt_post) + geom_boxplot(mapping = aes(x = as.factor(t), y = kt)) + geom_boxplot(mapping = aes(x = as.factor(t), y = kt_true, color = 'red'))
phi_post = data.frame(phi = as.numeric(t(post_samples_sim %>% select('phi'))), phi_true = rep(phi_true,1000))
ggplot(data = phi_post) + geom_boxplot(mapping = aes(y = phi)) + geom_boxplot(mapping = aes(y = phi_true, color = 'red'))
# Test to see wether the true value of the true paratmeters are within the posterior distribution
apc_fit_sim <- apc_stan(death = death_sim_apc,exposure=exposureGBR, validation=0,forecast = 10, family = "nb",chains=1,cores=4)
post_samples_sim <- as.data.frame(apc_fit_sim)
a_true <- t(post_mean_apc %>% select(starts_with('a[')))
kt_true <-  t(post_mean_apc %>% select(starts_with('k[')))
g_true <-  t(post_mean_apc %>% select(starts_with('g[')))
phi_true <-  t(post_mean_apc %>% select(starts_with('phi')))
ages <- 50:90
years <- 1979:2008
ax_post = data.frame(a=double(), x = integer(), a_true = double())
for (k in 1:length(ages)){
ax_post = rbind(ax_post,
data.frame(a = as.numeric(t(post_samples_sim %>% select(paste0('a[',k,']')))), x = rep(ages[k],1000), a_true = rep(a_true[k],1000))
)
}
ggplot(data = ax_post) + geom_boxplot(mapping = aes(x = as.factor(x), y = a)) + geom_boxplot(mapping = aes(x = as.factor(x), y = a_true, color = 'red'))
kt_post = data.frame(kt=double(), t = integer(), kt_true = double())
for(k in 1:length(years)){
kt_post = rbind(kt_post,
data.frame(kt = as.numeric(t(post_samples_sim %>% select(paste0('k[',k,']')))), t = rep(years[k],1000), kt_true = rep(kt_true[k],1000))
)
}
ggplot(data = kt_post) + geom_boxplot(mapping = aes(x = as.factor(t), y = kt)) + geom_boxplot(mapping = aes(x = as.factor(t), y = kt_true, color = 'red'))
g_post = data.frame(g=double(), t = integer(), g_true = double())
for(k in 1:length(cohorts)){
g_post = rbind(g_post,
data.frame(g = as.numeric(t(post_samples_sim %>% select(paste0('g[',k,']')))), co = rep(cohorts[k],1000), g_true = rep(g_true[k],1000))
)
}
ggplot(data = g_post) + geom_boxplot(mapping = aes(x = as.factor(co), y = g)) + geom_boxplot(mapping = aes(x = as.factor(co), y = g_true, color = 'red'))
phi_post = data.frame(phi = as.numeric(t(post_samples_sim %>% select('phi'))), phi_true = rep(phi_true,1000))
ggplot(data = phi_post) + geom_boxplot(mapping = aes(y = phi)) + geom_boxplot(mapping = aes(y = phi_true, color = 'red'))
library(parallel)
ages.fit<-50:90
samplingfunction<-function(x){
if (x==1) res<-lc_stan(death = death_sim_lc,exposure=exposureGBR, validation=10,forecast = 10, family = "nb",chains=1,cores=1)
else if (x==2) res<-rh_stan(death = death_sim_lc,exposure=exposureGBR, validation=10,forecast = 10, family = "nb",chains=1,cores=1)
else if (x==3) res<-apc_stan(death = death_sim_lc,exposure=exposureGBR, validation=10,forecast = 10, family = "nb",chains=1,cores=1)
else if (x==4) res<-cbd_stan(death = death_sim_lc,exposure=exposureGBR, age=ages.fit,
validation=10,forecast = 10, family = "nb",chains=1,cores=1)
else if (x==5) res<-m6_stan(death = death_sim_lc,exposure=exposureGBR, age=ages.fit,
validation=10,forecast = 10, family = "nb",chains=1,cores=1)
}
cl <- makeCluster(4)
clusterExport(cl,c('death_sim_lc','exposureGBR','ages.fit','lc_stan','rh_stan','apc_stan','cbd_stan','m6_stan'))
system.time({out <- parLapply(cl, c(1:5),samplingfunction)})
stopCluster(cl)
#Weights stacking Pseudo-BMA
model_weights<-mortality_weights(out)
print(model_weights)
library(parallel)
ages.fit<-50:90
samplingfunction<-function(x){
if (x==1) res<-lc_stan(death = death_sim_apc,exposure=exposureGBR, validation=10,forecast = 10, family = "nb",chains=1,cores=1)
else if (x==2) res<-rh_stan(death = death_sim_apc,exposure=exposureGBR, validation=10,forecast = 10, family = "nb",chains=1,cores=1)
else if (x==3) res<-apc_stan(death = death_sim_apc,exposure=exposureGBR, validation=10,forecast = 10, family = "nb",chains=1,cores=1)
else if (x==4) res<-cbd_stan(death = death_sim_apc,exposure=exposureGBR, age=ages.fit,
validation=10,forecast = 10, family = "nb",chains=1,cores=1)
else if (x==5) res<-m6_stan(death = death_sim_apc,exposure=exposureGBR, age=ages.fit,
validation=10,forecast = 10, family = "nb",chains=1,cores=1)
}
cl <- makeCluster(4)
clusterExport(cl,c('death_sim_apc','exposureGBR','ages.fit','lc_stan','rh_stan','apc_stan','cbd_stan','m6_stan'))
system.time({out <- parLapply(cl, c(1:5),samplingfunction)})
stopCluster(cl)
#Weights stacking Pseudo-BMA
model_weights_apc<-mortality_weights(out)
print(model_weights_apc)
#Data
validation=0
forecast=10
family="nb"
death<-death_sim_lc
exposure<-exposureGBR
age<-ages.fit
Tval<-0
if (validation !=0) Tval=validation
if (Tval==0) {
death1<-death
exposure1<-exposure
death2<-vector('integer')
exposure2<-vector('integer')
index<-seq(3,ncol(death1))
} else {
T<- ncol(death)-Tval
death1<-death[,1:T]
death2<-death[,(T+1):ncol(death)]
exposure1<-exposure[,1:T]
exposure2<-exposure[,(T+1):ncol(exposure)]
index<-seq(3,T)
}
family<-match.arg(family)
if (family == "poisson") {
family <- 0
} else if (family == "nb") {
family <- 1
}
standata<- list(J=nrow(death1),T=ncol(death1),
d=as.integer(as.vector(death1)),
e=as.integer(as.vector(exposure1)),
dval=as.integer(as.vector(death2)),
eval=as.integer(as.vector(exposure2)),
Tfor=forecast,Tval=Tval,
family=family,index=index)
validation=0
forecast=10
family="nb"
death<-deathFR
validation=0
forecast=10
family="nb"
death<-death_sim_lc
exposure<-exposureGBR
age<-ages.fit
Tval<-0
if (validation !=0) Tval=validation
if (Tval==0) {
death1<-death
exposure1<-exposure
death2<-vector('integer')
exposure2<-vector('integer')
index<-seq(2,ncol(death1))
} else {
T<- ncol(death)-Tval
death1<-death[,1:T]
death2<-death[,(T+1):ncol(death)]
exposure1<-exposure[,1:T]
exposure2<-exposure[,(T+1):ncol(exposure)]
index<-seq(2,T)
}
if (family == "poisson") {
family <- 0
} else if (family == "nb") {
family <- 1
}
standata2<- list(J=nrow(death1),T=ncol(death1),
d=as.integer(as.vector(death1)),
e=as.integer(as.vector(exposure1)),
age=age,
dval=as.integer(as.vector(death2)),
eval=as.integer(as.vector(exposure2)),
Tfor=forecast,Tval=Tval,
family=family,index=index)
#Bridgesampling
rstan_options(javascript = FALSE)
options(buildtools.check = function(action) TRUE )
library(rstan)
#Bridgesampling
rstan_options(javascript = FALSE)
options(buildtools.check = function(action) TRUE )
new_mod1 <- stan('leecarter.stan', data=standata,chains = 0)
new_mod1 <- stan('leecarter.stan', data=standata,chains = 0)
new_mod1 <- stan('leecarter.stan', data=standata,chains = 1)
bridge1 <- bridge_sampler(out[[1]], new_mod1,silent = TRUE)
install.packages("bridgesampling")
library(bridgesampling)
bridge1 <- bridge_sampler(out[[1]], new_mod1,silent = TRUE)
new_mod1 <- stan('leecarter.stan', data=standata,chains = 0)
bridge1 <- bridge_sampler(out[[1]], new_mod1,silent = TRUE)
print(bridge1)
if (validation !=0) Tval=validation
#Data
validation=0
family="nb"
death<-death_sim_lc
exposure<-exposureGBR
age<-ages.fit
Tval<-0
if (validation !=0) Tval=validation
if (Tval==0) {
death1<-death
exposure1<-exposure
death2<-vector('integer')
exposure2<-vector('integer')
index<-seq(3,ncol(death1))
} else {
T<- ncol(death)-Tval
death1<-death[,1:T]
death2<-death[,(T+1):ncol(death)]
exposure1<-exposure[,1:T]
exposure2<-exposure[,(T+1):ncol(exposure)]
index<-seq(3,T)
}
family<-match.arg(family)
if (family == "poisson") {
family <- 0
} else if (family == "nb") {
family <- 1
}
standata<- list(J=nrow(death1),T=ncol(death1),
d=as.integer(as.vector(death1)),
e=as.integer(as.vector(exposure1)),
dval=as.integer(as.vector(death2)),
eval=as.integer(as.vector(exposure2)),
Tfor=forecast,Tval=Tval,
family=family,index=index)
#For CBD and M6
validation=0
forecast=10
family="nb"
death<-death_sim_lc
exposure<-exposureGBR
age<-ages.fit
Tval<-0
if (validation !=0) Tval=validation
if (Tval==0) {
death1<-death
exposure1<-exposure
death2<-vector('integer')
exposure2<-vector('integer')
index<-seq(2,ncol(death1))
} else {
T<- ncol(death)-Tval
death1<-death[,1:T]
death2<-death[,(T+1):ncol(death)]
exposure1<-exposure[,1:T]
exposure2<-exposure[,(T+1):ncol(exposure)]
index<-seq(2,T)
}
family<-match.arg(family)
if (family == "poisson") {
family <- 0
} else if (family == "nb") {
family <- 1
}
standata2<- list(J=nrow(death1),T=ncol(death1),
d=as.integer(as.vector(death1)),
e=as.integer(as.vector(exposure1)),
age=age,
dval=as.integer(as.vector(death2)),
eval=as.integer(as.vector(exposure2)),
Tfor=forecast,Tval=Tval,
family=family,index=index)
library(rstan)
library(bridgesampling)
#Bridgesampling
rstan_options(javascript = FALSE)
options(buildtools.check = function(action) TRUE )
new_mod1 <- stan('leecarter.stan', data=standata,chains = 0)
out[[1]]
bridge1 <- bridge_sampler(out[[1]], new_mod1,silent = TRUE)
ncol(death1)
nrow(death1)
deathFR
deathFR<-load_HMD_data('GBR_NP', 'Deaths_1x1', 1979:2008, 50:90, "Male")$mat
exposureFR<-load_HMD_data('GBR_NP', 'Exposures_1x1', 1979:2008, 50:90, "Male")$mat
validation=0
forecast=10
family="nb"
death<-deathFR
exposure<-exposureFR
age<-ages.fit
age
Tval<-0
if (validation !=0) Tval=validation
if (Tval==0) {
death1<-death
exposure1<-exposure
death2<-vector('integer')
exposure2<-vector('integer')
index<-seq(2,ncol(death1))
} else {
T<- ncol(death)-Tval
death1<-death[,1:T]
death2<-death[,(T+1):ncol(death)]
exposure1<-exposure[,1:T]
exposure2<-exposure[,(T+1):ncol(exposure)]
index<-seq(2,T)
}
family<-match.arg(family)
if (family == "poisson") {
family <- 0
} else if (family == "nb") {
family <- 1
}
standata2<- list(J=nrow(death1),T=ncol(death1),
d=as.integer(as.vector(death1)),
e=as.integer(as.vector(exposure1)),
age=age,
dval=as.integer(as.vector(death2)),
eval=as.integer(as.vector(exposure2)),
Tfor=forecast,Tval=Tval,
family=family,index=index)
rstan_options(javascript = FALSE)
options(buildtools.check = function(action) TRUE )
new_mod1 <- stan('leecarter.stan', data=standata,chains = 0)
bridge1 <- bridge_sampler(out[[1]], new_mod1,silent = TRUE)
new_mod1 <- stan('leecarter.stan', data=standata,chains = 0)
new_mod1
new_mod1
bridge1 <- bridge_sampler(out[[1]], new_mod1,silent = TRUE)
out[[1]]
out
print(model_weights_apc)
print(model_weights_lc)
samplingfunction<-function(x){
if (x==1) res<-lc_stan(death = death_sim_lc,exposure=exposureGBR, validation=0,forecast = 10, family = "nb",chains=1,cores=1)
else if (x==2) res<-rh_stan(death = death_sim_lc,exposure=exposureGBR, validation=0,forecast = 10, family = "nb",chains=1,cores=1)
else if (x==3) res<-apc_stan(death = death_sim_lc,exposure=exposureGBR, validation=0,forecast = 10, family = "nb",chains=1,cores=1)
else if (x==4) res<-cbd_stan(death = death_sim_lc,exposure=exposureGBR, age=ages.fit,
validation=0,forecast = 10, family = "nb",chains=1,cores=1)
else if (x==5) res<-m6_stan(death = death_sim_lc,exposure=exposureGBR, age=ages.fit,
validation=0,forecast = 10, family = "nb",chains=1,cores=1)
}
cl <- makeCluster(4)
clusterExport(cl,c('death_sim_lc','exposureGBR','ages.fit','lc_stan','rh_stan','apc_stan','cbd_stan','m6_stan'))
system.time({out <- parLapply(cl, c(1:5),samplingfunction)})
>>>>>>> 6e250fe1bbfef8922877cef8aa0a4bffdc3cc151
