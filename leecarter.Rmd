---
title: "Bayesian Lee Carter with Stan"
output:
  github_document:
    pandoc_args: --webtex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This vignette explains how to estimate the Lee-Carter model using the `lc_stan` function in the **StanMoMo** package.

First, after installing the package, you have to load the package via: 
```{r}
library(StanMoMo)
```

For illustration, the package already includes the object `FRMaleData` containing deaths (`FRMaleData$Dxt`) and central exposures (`FRMaleData$Ext`) for French males for the period 1816-2017 and for ages 0-100. In our example, we concentrated on ages 50-90 and the period 1970-2017. This can be obtained via: 

```{r}
ages.fit<-50:90
years.fit<-1970:2007
deathFR<-FRMaleData$Dxt[formatC(ages.fit),formatC(years.fit)]
exposureFR<-FRMaleData$Ext[formatC(ages.fit),formatC(years.fit)]
```

As a reminder, the Lee-Carter model assumes that mortality dynamics are given by 
$$ 
\begin{aligned}
D_{xt} &\sim Poisson (E_{xt}\mu_{xt})\\
\log \mu_{xt}&=\alpha_x+\beta_x \kappa_t
\end{aligned}
$$
To ensure identifiability of the model, we assume that 
$$
\sum_x \beta_x=1,\kappa_1=0
$$

Moreover, we make the standard assumption that the period parameter follows a random walk with drift: 
$$ 
\kappa_t \sim \mathcal{N}(\mu+\kappa_{t-1},\sigma)
$$

## Bayesian Estimation

Now, the model can be estimated and forecast for the next 10 years by a simple call to the `lc_stan` function: 

```{r}
fitLC=lc_stan(death = deathFR,exposure=exposureFR, forecast = 10, family = "poisson",cores=4)
```

By default, Stan samples four Markov chains with 2000 iterations with 1000 warmup iterations for each chain (hence, 4000 draws in total). The output is an object of class `stanfit` (cf. the **rstan** package) which contains the posterior draws of each parameter, the posterior log likelihoods as well as the mortality forecasts.

We can then obtain an overview of the sampling for each parameter by calling the `print` function. For instance, different quantiles for $\alpha_x$, for $x=50,\dots,90$, based on the 4000 draws can be obtained via 
```{r}
print(fitLC,pars = "a")
```

We can also use the output to produce fan charts depicting the uncertainty around each parameter of the model fit.
```{r , echo=TRUE}
library("fanplot")
library("RColorBrewer")
library(latex2exp)
params<-rstan::extract(fitLC)
#Alpha
plot(ages.fit, colMeans(params$a), ylim=range(params$a),ylab=TeX("$\\alpha_x$"), xlab="Age: x")
fan(data=params$a, start=ages.fit[1],type = "interval", ln=NULL,probs = seq(0.01,0.99,0.01),
    fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Oranges"))))
#Beta
plot(ages.fit, colMeans(params$b), ylim=range(params$b),ylab=TeX("$\\beta_x$"), xlab="Age: x")
fan(data=params$b, start=ages.fit[1],type = "interval", ln = NULL,probs = seq(0.01,0.99,0.01),
    fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Reds"))))
#Kappa
plot(years.fit, colMeans(params$k), ylim=range(params$k),ylab=TeX("$\\kappa_t$"), xlab="Year: t")
fan(data=params$k, start=years.fit[1],type = "percentile",ln = NULL, probs = seq(0.01,0.99,0.01),
    fan.col = colorRampPalette(colors = rev(brewer.pal(9,"Blues"))))
```

## Forecasting


Predictions of death rates for the next 10 years with confidence intervals can be obtained as follows: 

```{r , echo=TRUE}
# Resize the forecast deaths rates as an array "Number of draws X Ages X Years to predict"
samplesize<-4000
years.predict<-2008:2017
pred<-array(params$mufor,dim=list(samplesize,length(ages.fit),length(years.predict)),
            dimnames = list(c(1:samplesize),formatC(ages.fit),formatC(years.predict)))
#Fan plots for ages 65,75,85
probs = c(2.5, 10, 25, 50, 75, 90, 97.5)
qxt <- deathFR / exposureFR
matplot(years.fit, t(qxt[c("65", "75", "85"), ]),
        xlim = c(1970, 2017), ylim = c(0.0025, 0.2), pch = 20, col = "black",
        log = "y", xlab = "year", ylab = "death rate (log scale)")
fan(pred[,"65" , ], start = 2008, probs = probs, n.fan = 4,
    fan.col =  colorRampPalette(colors = rev(brewer.pal(9,"Reds"))), ln = NULL)
fan(pred[,"75" , ], start = 2008, probs = probs, n.fan = 4,
    fan.col =  colorRampPalette(colors = rev(brewer.pal(9,"Greens"))), ln = NULL)
fan(pred[,"85" , ], start = 2008, probs = probs, n.fan = 4,
    fan.col =  colorRampPalette(colors = rev(brewer.pal(9,"Blues"))), ln = NULL)
text(1980, qxt[c("65", "75", "85"), "2000"],
     labels = c("x = 65", "x = 75", "x = 85"))
```
